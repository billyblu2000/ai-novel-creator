import React, { useState, useEffect, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { 
  ArrowLeft, 
  Save, 
  Clock,
  BookOpen,
  Users,
  MapPin,
  Settings,
  ChevronLeft,
  ChevronRight,
  Type,
  Plus,
  Link,
  Unlink
} from 'lucide-react';
import type { PlotElement, Character, WorldSetting, Timeline, CreateCharacterData, CreateWorldSettingData, CreateTimelineData } from '../types';
import { plotElementsApi, charactersApi, worldSettingsApi, timelinesApi } from '../services/api';
import { EditCharacterModal } from './EditCharacterModal';
import { EditWorldSettingModal } from './EditWorldSettingModal';
import { CreateTimelineModal } from './CreateTimelineModal';

export const ChapterEditor: React.FC = () => {
  const { projectId, elementId } = useParams<{ projectId: string; elementId: string }>();
  const navigate = useNavigate();
  const editorRef = useRef<HTMLTextAreaElement>(null);
  const [element, setElement] = useState<PlotElement | null>(null);
  const [characters, setCharacters] = useState<Character[]>([]);
  const [worldSettings, setWorldSettings] = useState<WorldSetting[]>([]);
  const [timelines, setTimelines] = useState<Timeline[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [showPreview, setShowPreview] = useState(false);
  const [showSidebar, setShowSidebar] = useState(true);
  const [showFontPanel, setShowFontPanel] = useState(false);
  const [showSummaryModal, setShowSummaryModal] = useState(false);
  const [showNotesModal, setShowNotesModal] = useState(false);
  const [wordCount, setWordCount] = useState(0);
  const [lastSaved, setLastSaved] = useState<Date | null>(null);
  const [fontSize, setFontSize] = useState(18);
  const [fontFamily, setFontFamily] = useState('serif');

  // ModalÁä∂ÊÄÅ
  const [showCreateCharacterModal, setShowCreateCharacterModal] = useState(false);
  const [showCreateWorldSettingModal, setShowCreateWorldSettingModal] = useState(false);
  const [showCreateTimelineModal, setShowCreateTimelineModal] = useState(false);
  const [editingCharacter, setEditingCharacter] = useState<Character | null>(null);
  const [editingWorldSetting, setEditingWorldSetting] = useState<WorldSetting | null>(null);

  // ÁºñËæëÂô®Áä∂ÊÄÅ
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [summary, setSummary] = useState('');
  const [notes, setNotes] = useState('');
  const [status, setStatus] = useState<'planned' | 'outlined' | 'drafted' | 'completed'>('planned');
  const [targetWords, setTargetWords] = useState<number | undefined>();
  const [mood, setMood] = useState('');
  const [pov, setPov] = useState('');

  useEffect(() => {
    if (projectId && elementId) {
      loadData();
    }
  }, [projectId, elementId]);

  useEffect(() => {
    // ËÆ°ÁÆóÂ≠óÊï∞
    const text = content.replace(/\s+/g, '').trim();
    setWordCount(text.length);
  }, [content]);

  useEffect(() => {
    // Ëá™Âä®‰øùÂ≠ò
    if (element && !saving) {
      const timer = setTimeout(() => {
        handleSave(true);
      }, 3000);
      return () => clearTimeout(timer);
    }
  }, [content, title, summary, notes, status, targetWords, mood, pov]);

  const loadData = async () => {
    if (!projectId || !elementId) return;
    
    try {
      setLoading(true);
      const [elementData, charactersData, worldSettingsData, timelinesData] = await Promise.all([
        plotElementsApi.getById(elementId),
        charactersApi.getByProject(projectId),
        worldSettingsApi.getByProject(projectId),
        timelinesApi.getByProject(projectId)
      ]);
      
      setElement(elementData);
      setCharacters(charactersData);
      setWorldSettings(worldSettingsData);
      setTimelines(timelinesData);
      
      // ËÆæÁΩÆË°®ÂçïÊï∞ÊçÆ
      setTitle(elementData.title);
      setContent(elementData.content || '');
      setSummary(elementData.summary || '');
      setNotes(elementData.notes || '');
      setStatus(elementData.status);
      setTargetWords(elementData.targetWords);

    } catch (error) {
      console.error('Error loading data:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async (isAutoSave = false) => {
    if (!element || saving) return;
    
    try {
      setSaving(true);
      await plotElementsApi.update(element.id, {
        title,
        content,
        summary,
        notes,
        status,
        targetWords,
        mood,
        pov
      });
      
      setLastSaved(new Date());
      if (!isAutoSave) {
        // ÊòæÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫
      }
    } catch (error) {
      console.error('Error saving:', error);
    } finally {
      setSaving(false);
    }
  };

  const handleBack = () => {
    navigate(`/project/${projectId}`);
  };

  const getFontFamilyStyle = (family: string) => {
    switch (family) {
      case 'serif': return '"Times New Roman", "SimSun", serif';
      case 'sans-serif': return '"Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif';
      case 'monospace': return '"Consolas", "Monaco", "Courier New", monospace';
      case 'kai': return '"KaiTi", "Ê•∑‰Ωì", serif';
      case 'song': return '"SimSun", "ÂÆã‰Ωì", serif';
      default: return '"Times New Roman", "SimSun", serif';
    }
  };

  const getTypeIcon = (type: string) => {
    switch (type) {
      case 'book': return 'üìö';
      case 'part': return 'üìñ';
      case 'chapter': return 'üìÑ';
      case 'scene': return 'üé¨';
      case 'beat': return 'üéµ';
      default: return 'üìù';
    }
  };

  // ÂÖ≥ËÅîÁÆ°ÁêÜÂáΩÊï∞
  const handleLinkCharacter = async (characterId: string) => {
    if (!element) return;
    try {
      await plotElementsApi.linkCharacter(element.id, characterId);
      loadData();
    } catch (error) {
      console.error('Error linking character:', error);
    }
  };

  const handleUnlinkCharacter = async (characterId: string) => {
    if (!element) return;
    try {
      await plotElementsApi.unlinkCharacter(element.id, characterId);
      loadData();
    } catch (error) {
      console.error('Error unlinking character:', error);
    }
  };

  const handleLinkWorldSetting = async (settingId: string) => {
    if (!element) return;
    try {
      await plotElementsApi.linkSetting(element.id, settingId);
      loadData();
    } catch (error) {
      console.error('Error linking world setting:', error);
    }
  };

  const handleUnlinkWorldSetting = async (settingId: string) => {
    if (!element) return;
    try {
      await plotElementsApi.unlinkSetting(element.id, settingId);
      loadData();
    } catch (error) {
      console.error('Error unlinking world setting:', error);
    }
  };

  const handleLinkTimeline = async (timelineId: string) => {
    if (!element) return;
    try {
      await timelinesApi.linkPlotElement(timelineId, element.id, 'main');
      loadData();
    } catch (error) {
      console.error('Error linking timeline:', error);
    }
  };

  const handleUnlinkTimeline = async (timelineId: string) => {
    if (!element) return;
    try {
      await timelinesApi.unlinkPlotElement(timelineId, element.id);
      loadData();
    } catch (error) {
      console.error('Error unlinking timeline:', error);
    }
  };

  // ÂàõÂª∫Âπ∂ÂÖ≥ËÅîÂáΩÊï∞
  const handleCreateAndLinkCharacter = async (data: CreateCharacterData) => {
    try {
      const newCharacter = await charactersApi.create(data);
      if (element) {
        await plotElementsApi.linkCharacter(element.id, newCharacter.id);
      }
      loadData();
      setShowCreateCharacterModal(false);
    } catch (error) {
      console.error('Error creating and linking character:', error);
    }
  };

  const handleCreateAndLinkWorldSetting = async (data: CreateWorldSettingData) => {
    try {
      const newSetting = await worldSettingsApi.create(data);
      if (element) {
        await plotElementsApi.linkSetting(element.id, newSetting.id);
      }
      loadData();
      setShowCreateWorldSettingModal(false);
    } catch (error) {
      console.error('Error creating and linking world setting:', error);
    }
  };

  const handleCreateAndLinkTimeline = async (data: CreateTimelineData) => {
    try {
      const newTimeline = await timelinesApi.create(data);
      if (element) {
        await timelinesApi.linkPlotElement(newTimeline.id, element.id, 'main');
      }
      loadData();
      setShowCreateTimelineModal(false);
    } catch (error) {
      console.error('Error creating and linking timeline:', error);
    }
  };

  // ÁºñËæëËßíËâ≤
  const handleUpdateCharacter = async (id: string, data: any) => {
    try {
      await charactersApi.update(id, data);
      loadData();
      setEditingCharacter(null);
    } catch (error) {
      console.error('Error updating character:', error);
    }
  };

  // ÁºñËæë‰∏ñÁïåËÆæÂÆö
  const handleUpdateWorldSetting = async (data: any) => {
    if (!editingWorldSetting) return;
    try {
      await worldSettingsApi.update(editingWorldSetting.id, data);
      loadData();
      setEditingWorldSetting(null);
    } catch (error) {
      console.error('Error updating world setting:', error);
    }
  };

  // Ëé∑ÂèñÂÖ≥ËÅîÁä∂ÊÄÅ
  const isCharacterLinked = (characterId: string) => {
    return element?.characters?.some(c => c.characterId === characterId) || false;
  };

  const isWorldSettingLinked = (settingId: string) => {
    return element?.settings?.some(s => s.settingId === settingId) || false;
  };

  const isTimelineLinked = (timelineId: string) => {
    return element?.timelines?.some(t => t.timelineId === timelineId) || false;
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-black dark:border-white"></div>
      </div>
    );
  }

  if (!element) {
    return (
      <div className="min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <p className="text-red-600 dark:text-red-400 mb-4">Á´†ËäÇÊú™ÊâæÂà∞</p>
          <button 
            onClick={handleBack}
            className="px-4 py-2 bg-black dark:bg-white text-white dark:text-black rounded-md hover:bg-gray-800 dark:hover:bg-gray-200 transition-colors"
          >
            ËøîÂõûÈ°πÁõÆ
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="h-screen bg-white dark:bg-gray-900 flex overflow-hidden">
      {/* Â∑¶‰æßËæπÊ†è */}
      {showSidebar && (
        <div className="w-80 bg-gray-50 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col h-full">
          {/* ‰æßËæπÊ†èÂ§¥ÈÉ® */}
          <div className="p-4 border-b border-gray-200 dark:border-gray-700">
            <div className="flex items-center space-x-3 mb-4">
              <button
                onClick={handleBack}
                className="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md transition-colors text-gray-600 dark:text-gray-400"
              >
                <ArrowLeft className="w-5 h-5" />
              </button>
              <span className="text-2xl">{getTypeIcon(element.type)}</span>
              <div>
                <h2 className="font-semibold text-gray-900 dark:text-white">{element.type === 'chapter' ? 'Á´†ËäÇ' : 'Âú∫ÊôØ'}ÁºñËæë</h2>
                <p className="text-sm text-gray-500 dark:text-gray-400">
                  {wordCount.toLocaleString()} Â≠ó
                  {targetWords && ` / ${targetWords.toLocaleString()} Â≠ó`}
                </p>
              </div>
            </div>
            
            {/* ËøõÂ∫¶Êù° */}
            {targetWords && (
              <div className="mb-4">
                <div className="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full">
                  <div 
                    className="h-2 bg-black dark:bg-white rounded-full transition-all duration-300"
                    style={{ width: `${Math.min(100, (wordCount / targetWords) * 100)}%` }}
                  />
                </div>
                <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  {Math.round((wordCount / targetWords) * 100)}% ÂÆåÊàê
                </div>
              </div>
            )}

            {/* ‰øùÂ≠òÁä∂ÊÄÅ */}
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-2">
                <button
                  onClick={() => handleSave(false)}
                  disabled={saving}
                  className="flex items-center space-x-2 px-3 py-1 bg-black dark:bg-white text-white dark:text-black rounded-md hover:bg-gray-800 dark:hover:bg-gray-200 transition-colors disabled:opacity-50 text-sm"
                >
                  <Save className="w-3 h-3" />
                  <span>{saving ? '‰øùÂ≠ò‰∏≠...' : '‰øùÂ≠ò'}</span>
                </button>
                
                <button
                  onClick={() => setShowPreview(!showPreview)}
                  className="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md transition-colors text-gray-600 dark:text-gray-400"
                  title={showPreview ? 'ÁºñËæëÊ®°Âºè' : 'È¢ÑËßàÊ®°Âºè'}
                >
                  {showPreview ? <Type className="w-4 h-4" /> : <BookOpen className="w-4 h-4" />}
                </button>
              </div>
              
              {lastSaved && (
                <span className="text-xs text-gray-500 dark:text-gray-400 flex items-center">
                  <Clock className="w-3 h-3 mr-1" />
                  {lastSaved.toLocaleTimeString()}
                </span>
              )}
            </div>
          </div>

          {/* ‰æßËæπÊ†èÂÜÖÂÆπ */}
          <div className="flex-1 p-4 space-y-6 overflow-y-auto">
            {/* Ê†áÈ¢òÁºñËæë */}
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Ê†áÈ¢ò
              </label>
              <input
                type="text"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:border-black dark:focus:border-white bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                placeholder="ËæìÂÖ•Ê†áÈ¢ò..."
              />
            </div>

            {/* Á´†ËäÇÊ¶ÇË¶ÅÈ¢ÑËßà */}
            <div>
              <div className="flex items-center justify-between mb-2">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                  Á´†ËäÇÊ¶ÇË¶Å
                </label>
                <button
                  onClick={() => setShowSummaryModal(true)}
                  className="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
                >
                  ÁºñËæë
                </button>
              </div>
              <div className="p-3 bg-white dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600 min-h-[60px]">
                {summary ? (
                  <p className="text-sm text-gray-700 dark:text-gray-300 line-clamp-3">
                    {summary}
                  </p>
                ) : (
                  <p className="text-sm text-gray-500 dark:text-gray-400 italic">
                    ÁÇπÂáªÁºñËæëÊ∑ªÂä†Á´†ËäÇÊ¶ÇË¶Å...
                  </p>
                )}
              </div>
            </div>

            {/* Âàõ‰ΩúÁ¨îËÆ∞È¢ÑËßà */}
            <div>
              <div className="flex items-center justify-between mb-2">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                  Âàõ‰ΩúÁ¨îËÆ∞
                </label>
                <button
                  onClick={() => setShowNotesModal(true)}
                  className="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
                >
                  ÁºñËæë
                </button>
              </div>
              <div className="p-3 bg-white dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600 min-h-[60px]">
                {notes ? (
                  <p className="text-sm text-gray-700 dark:text-gray-300 line-clamp-3">
                    {notes}
                  </p>
                ) : (
                  <p className="text-sm text-gray-500 dark:text-gray-400 italic">
                    ÁÇπÂáªÁºñËæëÊ∑ªÂä†Âàõ‰ΩúÁ¨îËÆ∞...
                  </p>
                )}
              </div>
            </div>

            {/* Âü∫Êú¨‰ø°ÊÅØ */}
            <div>
              <h3 className="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                <Settings className="w-4 h-4 mr-2" />
                Á´†ËäÇËÆæÁΩÆ
              </h3>
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Áä∂ÊÄÅ
                  </label>
                  <select
                    value={status}
                    onChange={(e) => setStatus(e.target.value as any)}
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:border-black dark:focus:border-white bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
                  >
                    <option value="planned">ËÆ°Âàí‰∏≠</option>
                    <option value="outlined">Â∑≤Â§ßÁ∫≤</option>
                    <option value="drafted">ËçâÁ®ø</option>
                    <option value="completed">Â∑≤ÂÆåÊàê</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    ÁõÆÊ†áÂ≠óÊï∞
                  </label>
                  <input
                    type="number"
                    value={targetWords || ''}
                    onChange={(e) => setTargetWords(e.target.value ? parseInt(e.target.value) : undefined)}
                    placeholder="ËÆæÁΩÆÁõÆÊ†áÂ≠óÊï∞"
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:border-black dark:focus:border-white bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Âü∫Ë∞É/Ê∞õÂõ¥
                  </label>
                  <input
                    type="text"
                    value={mood}
                    onChange={(e) => setMood(e.target.value)}
                    placeholder="Â¶ÇÔºöÁ¥ßÂº†„ÄÅÊ∏©È¶®„ÄÅÊÇ≤‰º§"
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:border-black dark:focus:border-white bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    ËßÜËßí
                  </label>
                  <input
                    type="text"
                    value={pov}
                    onChange={(e) => setPov(e.target.value)}
                    placeholder="Â¶ÇÔºöÁ¨¨‰∏Ä‰∫∫Áß∞„ÄÅÁ¨¨‰∏â‰∫∫Áß∞"
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:border-black dark:focus:border-white bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
                  />
                </div>
              </div>
            </div>

            {/* ÂÖ≥ËÅîÊó∂Èó¥Á∫ø */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-medium text-gray-900 dark:text-white flex items-center">
                  <Clock className="w-4 h-4 mr-2" />
                  ÂÖ≥ËÅîÊó∂Èó¥Á∫ø
                </h3>
                <button
                  onClick={() => setShowCreateTimelineModal(true)}
                  className="p-1 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-md transition-colors"
                  title="Êñ∞Âª∫Êó∂Èó¥Á∫ø"
                >
                  <Plus className="w-4 h-4" />
                </button>
              </div>
              <div className="space-y-2">
                {/* Â∑≤ÂÖ≥ËÅîÁöÑÊó∂Èó¥Á∫ø */}
                {element?.timelines?.map((timelineRelation) => {
                  const timeline = timelines.find(t => t.id === timelineRelation.timelineId);
                  if (!timeline) return null;
                  return (
                    <div key={timeline.id} className="flex items-center justify-between p-2 bg-white dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600">
                      <div className="flex items-center space-x-2 flex-1">
                        <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                        <span className="text-sm text-gray-900 dark:text-white font-medium">{timeline.name}</span>
                        <span className="text-xs text-gray-500 dark:text-gray-400">{timelineRelation.relationship}</span>
                      </div>
                      <button
                        onClick={() => handleUnlinkTimeline(timeline.id)}
                        className="p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors"
                        title="ÂèñÊ∂àÂÖ≥ËÅî"
                      >
                        <Unlink className="w-3 h-3" />
                      </button>
                    </div>
                  );
                })}
                
                {/* Êú™ÂÖ≥ËÅîÁöÑÊó∂Èó¥Á∫ø */}
                {timelines.filter(timeline => !isTimelineLinked(timeline.id)).map((timeline) => (
                  <div key={timeline.id} className="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-600">
                    <div className="flex items-center space-x-2 flex-1">
                      <div className="w-2 h-2 rounded-full bg-gray-400"></div>
                      <span className="text-sm text-gray-600 dark:text-gray-400">{timeline.name}</span>
                    </div>
                    <button
                      onClick={() => handleLinkTimeline(timeline.id)}
                      className="p-1 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-md transition-colors"
                      title="Ê∑ªÂä†ÂÖ≥ËÅî"
                    >
                      <Link className="w-3 h-3" />
                    </button>
                  </div>
                ))}
                
                {timelines.length === 0 && (
                  <p className="text-sm text-gray-500 dark:text-gray-400 italic text-center py-2">
                    ÊöÇÊó†Êó∂Èó¥Á∫øÔºåÁÇπÂáª + ÂàõÂª∫
                  </p>
                )}
              </div>
            </div>

            {/* ÂÖ≥ËÅîËßíËâ≤ */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-medium text-gray-900 dark:text-white flex items-center">
                  <Users className="w-4 h-4 mr-2" />
                  ÂÖ≥ËÅîËßíËâ≤
                </h3>
                <button
                  onClick={() => setShowCreateCharacterModal(true)}
                  className="p-1 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-md transition-colors"
                  title="Êñ∞Âª∫ËßíËâ≤"
                >
                  <Plus className="w-4 h-4" />
                </button>
              </div>
              <div className="space-y-2">
                {/* Â∑≤ÂÖ≥ËÅîÁöÑËßíËâ≤ */}
                {element?.characters?.map((characterRelation) => {
                  const character = characters.find(c => c.id === characterRelation.characterId);
                  if (!character) return null;
                  return (
                    <div key={character.id} className="flex items-center justify-between p-2 bg-white dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600">
                      <div className="flex items-center space-x-2 flex-1">
                        <div className="w-2 h-2 rounded-full bg-green-500"></div>
                        <span className="text-sm text-gray-900 dark:text-white font-medium">{character.name}</span>
                        <span className="text-xs text-gray-500 dark:text-gray-400">{character.role}</span>
                      </div>
                      <div className="flex items-center space-x-1">
                        <button
                          onClick={() => setEditingCharacter(character)}
                          className="p-1 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors"
                          title="ÁºñËæëËßíËâ≤"
                        >
                          <Settings className="w-3 h-3" />
                        </button>
                        <button
                          onClick={() => handleUnlinkCharacter(character.id)}
                          className="p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors"
                          title="ÂèñÊ∂àÂÖ≥ËÅî"
                        >
                          <Unlink className="w-3 h-3" />
                        </button>
                      </div>
                    </div>
                  );
                })}
                
                {/* Êú™ÂÖ≥ËÅîÁöÑËßíËâ≤ */}
                {characters.filter(character => !isCharacterLinked(character.id)).map((character) => (
                  <div key={character.id} className="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-600">
                    <div className="flex items-center space-x-2 flex-1">
                      <div className="w-2 h-2 rounded-full bg-gray-400"></div>
                      <span className="text-sm text-gray-600 dark:text-gray-400">{character.name}</span>
                      <span className="text-xs text-gray-500 dark:text-gray-400">{character.role}</span>
                    </div>
                    <div className="flex items-center space-x-1">
                      <button
                        onClick={() => setEditingCharacter(character)}
                        className="p-1 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors"
                        title="ÁºñËæëËßíËâ≤"
                      >
                        <Settings className="w-3 h-3" />
                      </button>
                      <button
                        onClick={() => handleLinkCharacter(character.id)}
                        className="p-1 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-md transition-colors"
                        title="Ê∑ªÂä†ÂÖ≥ËÅî"
                      >
                        <Link className="w-3 h-3" />
                      </button>
                    </div>
                  </div>
                ))}
                
                {characters.length === 0 && (
                  <p className="text-sm text-gray-500 dark:text-gray-400 italic text-center py-2">
                    ÊöÇÊó†ËßíËâ≤ÔºåÁÇπÂáª + ÂàõÂª∫
                  </p>
                )}
              </div>
            </div>

            {/* ÂÖ≥ËÅî‰∏ñÁïåËÆæÂÆö */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-medium text-gray-900 dark:text-white flex items-center">
                  <MapPin className="w-4 h-4 mr-2" />
                  ÂÖ≥ËÅîËÆæÂÆö
                </h3>
                <button
                  onClick={() => setShowCreateWorldSettingModal(true)}
                  className="p-1 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-md transition-colors"
                  title="Êñ∞Âª∫‰∏ñÁïåËÆæÂÆö"
                >
                  <Plus className="w-4 h-4" />
                </button>
              </div>
              <div className="space-y-2">
                {/* Â∑≤ÂÖ≥ËÅîÁöÑ‰∏ñÁïåËÆæÂÆö */}
                {element?.settings?.map((settingRelation) => {
                  const setting = worldSettings.find(s => s.id === settingRelation.settingId);
                  if (!setting) return null;
                  return (
                    <div key={setting.id} className="flex items-center justify-between p-2 bg-white dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600">
                      <div className="flex items-center space-x-2 flex-1">
                        <div className="w-2 h-2 rounded-full bg-purple-500"></div>
                        <span className="text-sm text-gray-900 dark:text-white font-medium">{setting.title}</span>
                        <span className="text-xs text-gray-500 dark:text-gray-400">{setting.category}</span>
                      </div>
                      <div className="flex items-center space-x-1">
                        <button
                          onClick={() => setEditingWorldSetting(setting)}
                          className="p-1 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors"
                          title="ÁºñËæëËÆæÂÆö"
                        >
                          <Settings className="w-3 h-3" />
                        </button>
                        <button
                          onClick={() => handleUnlinkWorldSetting(setting.id)}
                          className="p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors"
                          title="ÂèñÊ∂àÂÖ≥ËÅî"
                        >
                          <Unlink className="w-3 h-3" />
                        </button>
                      </div>
                    </div>
                  );
                })}
                
                {/* Êú™ÂÖ≥ËÅîÁöÑ‰∏ñÁïåËÆæÂÆö */}
                {worldSettings.filter(setting => !isWorldSettingLinked(setting.id)).map((setting) => (
                  <div key={setting.id} className="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-600">
                    <div className="flex items-center space-x-2 flex-1">
                      <div className="w-2 h-2 rounded-full bg-gray-400"></div>
                      <span className="text-sm text-gray-600 dark:text-gray-400">{setting.title}</span>
                      <span className="text-xs text-gray-500 dark:text-gray-400">{setting.category}</span>
                    </div>
                    <div className="flex items-center space-x-1">
                      <button
                        onClick={() => setEditingWorldSetting(setting)}
                        className="p-1 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors"
                        title="ÁºñËæëËÆæÂÆö"
                      >
                        <Settings className="w-3 h-3" />
                      </button>
                      <button
                        onClick={() => handleLinkWorldSetting(setting.id)}
                        className="p-1 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-md transition-colors"
                        title="Ê∑ªÂä†ÂÖ≥ËÅî"
                      >
                        <Link className="w-3 h-3" />
                      </button>
                    </div>
                  </div>
                ))}
                
                {worldSettings.length === 0 && (
                  <p className="text-sm text-gray-500 dark:text-gray-400 italic text-center py-2">
                    ÊöÇÊó†‰∏ñÁïåËÆæÂÆöÔºåÁÇπÂáª + ÂàõÂª∫
                  </p>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ‰∏ªÁºñËæëÂå∫Âüü */}
      <div className="flex-1 flex flex-col relative h-full">
        {/* ‰æßËæπÊ†èÂàáÊç¢ÊåâÈíÆ */}
        <button
          onClick={() => setShowSidebar(!showSidebar)}
          className="absolute top-4 left-4 z-10 p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-sm hover:shadow-md transition-all text-gray-600 dark:text-gray-400"
          title={showSidebar ? 'ÈöêËóè‰æßËæπÊ†è' : 'ÊòæÁ§∫‰æßËæπÊ†è'}
        >
          {showSidebar ? <ChevronLeft className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
        </button>

        {/* Â≠ó‰ΩìËÆæÁΩÆÊåâÈíÆ */}
        {!showPreview && (
          <button
            onClick={() => setShowFontPanel(!showFontPanel)}
            className="absolute top-4 right-4 z-10 p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-sm hover:shadow-md transition-all text-gray-600 dark:text-gray-400"
            title="Â≠ó‰ΩìËÆæÁΩÆ"
          >
            <Type className="w-4 h-4" />
          </button>
        )}

        {/* Â≠ó‰ΩìËÆæÁΩÆÈù¢Êùø */}
        {showFontPanel && !showPreview && (
          <div className="absolute top-16 right-4 z-10 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg p-4 w-64">
            <h3 className="font-medium text-gray-900 dark:text-white mb-3">Â≠ó‰ΩìËÆæÁΩÆ</h3>
            <div className="space-y-3">
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Â≠ó‰Ωì
                </label>
                <select
                  value={fontFamily}
                  onChange={(e) => setFontFamily(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:border-black dark:focus:border-white bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
                >
                  <option value="serif">Ë°¨Á∫øÂ≠ó‰Ωì (Times New Roman)</option>
                  <option value="sans-serif">Êó†Ë°¨Á∫øÂ≠ó‰Ωì (Helvetica)</option>
                  <option value="monospace">Á≠âÂÆΩÂ≠ó‰Ωì (Consolas)</option>
                  <option value="kai">Ê•∑‰Ωì</option>
                  <option value="song">ÂÆã‰Ωì</option>
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Â≠óÂè∑ ({fontSize}px)
                </label>
                <input
                  type="range"
                  min="14"
                  max="24"
                  value={fontSize}
                  onChange={(e) => setFontSize(parseInt(e.target.value))}
                  className="w-full"
                />
                <div className="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                  <span>14px</span>
                  <span>24px</span>
                </div>
              </div>
            </div>
          </div>
        )}



        {/* ÁºñËæëÂô®ÂÜÖÂÆπÂå∫Âüü */}
        <div className="flex-1 flex flex-col h-full">
          {showPreview ? (
            // È¢ÑËßàÊ®°Âºè
            <div className="flex-1 p-12 overflow-y-auto h-full">
              <div className="max-w-4xl mx-auto">
                <div className="prose prose-lg dark:prose-invert max-w-none">
                  <h1 className="text-3xl font-bold mb-6">{title}</h1>
                  {summary && (
                    <div className="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-6">
                      <h3 className="text-lg font-semibold mb-2">Á´†ËäÇÊ¶ÇË¶Å</h3>
                      <p className="text-gray-700 dark:text-gray-300">{summary}</p>
                    </div>
                  )}
                  <div className="whitespace-pre-wrap leading-relaxed text-lg">
                    {content}
                  </div>
                </div>
              </div>
            </div>
          ) : (
            // ÁºñËæëÊ®°Âºè - Ê≤âÊµ∏ÂºèÂÜô‰Ωú
            <div className="flex-1 flex flex-col h-full">
              <textarea
                ref={editorRef}
                value={content}
                onChange={(e) => setContent(e.target.value)}
                className="flex-1 resize-none border-none outline-none bg-white dark:bg-gray-900 text-gray-900 dark:text-white leading-relaxed"
                placeholder="ÂºÄÂßã‰Ω†ÁöÑÂàõ‰Ωú..."
                style={{ 
                  fontFamily: getFontFamilyStyle(fontFamily),
                  fontSize: `${fontSize}px`,
                  lineHeight: '1.8',
                  padding: '80px 60px 60px 80px' // ‰∏ä Âè≥ ‰∏ã Â∑¶
                }}
              />
            </div>
          )}
        </div>
      </div>

      {/* Á´†ËäÇÊ¶ÇË¶ÅÁºñËæëModal */}
      {showSummaryModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <div className="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
              <h3 className="text-lg font-semibold text-gray-900 dark:text-white">ÁºñËæëÁ´†ËäÇÊ¶ÇË¶Å</h3>
              <button
                onClick={() => setShowSummaryModal(false)}
                className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
              >
                ‚úï
              </button>
            </div>
            <div className="p-6">
              <textarea
                value={summary}
                onChange={(e) => setSummary(e.target.value)}
                placeholder="ÁÆÄË¶ÅÊèèËø∞Ëøô‰∏™Á´†ËäÇÁöÑ‰∏ªË¶ÅÂÜÖÂÆπ„ÄÅÂÖ≥ÈîÆÊÉÖËäÇÁÇπ„ÄÅ‰∫∫Áâ©ÂÖ≥Á≥ªÂèòÂåñÁ≠â..."
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:border-black dark:focus:border-white bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-y"
                rows={8}
              />
            </div>
            <div className="flex justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700">
              <button
                onClick={() => setShowSummaryModal(false)}
                className="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors"
              >
                ÂèñÊ∂à
              </button>
              <button
                onClick={() => setShowSummaryModal(false)}
                className="px-4 py-2 bg-black dark:bg-white text-white dark:text-black rounded-md hover:bg-gray-800 dark:hover:bg-gray-200 transition-colors"
              >
                ‰øùÂ≠ò
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Âàõ‰ΩúÁ¨îËÆ∞ÁºñËæëModal */}
      {showNotesModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <div className="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
              <h3 className="text-lg font-semibold text-gray-900 dark:text-white">ÁºñËæëÂàõ‰ΩúÁ¨îËÆ∞</h3>
              <button
                onClick={() => setShowNotesModal(false)}
                className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
              >
                ‚úï
              </button>
            </div>
            <div className="p-6">
              <textarea
                value={notes}
                onChange={(e) => setNotes(e.target.value)}
                placeholder="ËÆ∞ÂΩïÂàõ‰ΩúÊÄùË∑Ø„ÄÅÂæÖ‰øÆÊîπÁöÑÂú∞Êñπ„ÄÅÁÅµÊÑüÊÉ≥Ê≥ï„ÄÅËßíËâ≤ÂèëÂ±ïËÆ°ÂàíÁ≠â..."
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:border-black dark:focus:border-white bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-y"
                rows={8}
              />
            </div>
            <div className="flex justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700">
              <button
                onClick={() => setShowNotesModal(false)}
                className="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors"
              >
                ÂèñÊ∂à
              </button>
              <button
                onClick={() => setShowNotesModal(false)}
                className="px-4 py-2 bg-black dark:bg-white text-white dark:text-black rounded-md hover:bg-gray-800 dark:hover:bg-gray-200 transition-colors"
              >
                ‰øùÂ≠ò
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ÂàõÂª∫ËßíËâ≤Modal */}
      <EditCharacterModal
        isOpen={showCreateCharacterModal}
        onClose={() => setShowCreateCharacterModal(false)}
        onSubmit={async (_, data) => {
          if (!projectId) return;
          await handleCreateAndLinkCharacter({
            projectId,
            name: data.name || '',
            role: data.role || 'supporting',
            description: data.description || '',
            importance: data.importance || 5
          });
        }}
        character={null}
      />

      {/* ÁºñËæëËßíËâ≤Modal */}
      {editingCharacter && (
        <EditCharacterModal
          isOpen={!!editingCharacter}
          onClose={() => setEditingCharacter(null)}
          onSubmit={handleUpdateCharacter}
          character={editingCharacter}
        />
      )}

      {/* ÂàõÂª∫‰∏ñÁïåËÆæÂÆöModal */}
      <EditWorldSettingModal
        isOpen={showCreateWorldSettingModal}
        onClose={() => setShowCreateWorldSettingModal(false)}
        onSave={async (data) => {
          if ('projectId' in data) {
            await handleCreateAndLinkWorldSetting(data as CreateWorldSettingData);
          }
        }}
        projectId={projectId || ''}
      />

      {/* ÁºñËæë‰∏ñÁïåËÆæÂÆöModal */}
      {editingWorldSetting && (
        <EditWorldSettingModal
          isOpen={!!editingWorldSetting}
          onClose={() => setEditingWorldSetting(null)}
          onSave={handleUpdateWorldSetting}
          setting={editingWorldSetting}
          projectId={projectId || ''}
        />
      )}

      {/* ÂàõÂª∫Êó∂Èó¥Á∫øModal */}
      <CreateTimelineModal
        isOpen={showCreateTimelineModal}
        onClose={() => setShowCreateTimelineModal(false)}
        onSubmit={async (data) => {
          await handleCreateAndLinkTimeline(data as CreateTimelineData);
        }}
        projectId={projectId || ''}
      />
    </div>
  );
};